---
phase: 01-foundation-identity-family-privacy
plan: "02"
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - supabase/
  - supabase/migrations/
  - supabase/functions/
  - supabase/config.toml
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Non-members cannot access family resources server-side (no rows returned)"
    - "Recipe visibility (private/family/public) is enforced server-side"
    - "Public recipes are readable when logged out by direct ID lookup"
  artifacts:
    - path: supabase/migrations
      provides: "Schema + RLS policies for Phase 1"
    - path: supabase/functions
      provides: "Invite + reset primitives"
  key_links:
    - from: supabase/migrations
      to: supabase/functions
      via: "functions operate on invites/memberships tables"
---

<objective>
Implement the Phase 1 backend foundation in Supabase: schema, RLS policies, and minimal functions for invites and password reset semantics.

Purpose: Privacy is the product; enforce access control server-side from day one.
Output: Tables + RLS for profiles/families/memberships/invites/recipes and functions for invite + reset request behavior.
</objective>

<execution_context>
@/Users/elinicholson/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/elinicholson/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-identity-family-privacy/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Supabase project in-repo</name>
  <files>supabase/config.toml, supabase/</files>
  <action>
Initialize Supabase in-repo and confirm local services can start. Keep defaults unless needed for local dev.
  </action>
  <verify>supabase --version</verify>
  <done>`supabase/` exists with a valid config</done>
</task>

<task type="auto">
  <name>Task 2: Create schema + RLS policies for Phase 1 access rules</name>
  <files>supabase/migrations/*</files>
  <action>
Create migrations for these tables (minimum viable Phase 1):
- `profiles` (user_id PK references auth.users)
- `families`
- `family_memberships` with role enum admin|member
- `family_invites` storing token_hash (never raw token), expires_at, revoked_at, accepted_at
- `recipes` with visibility enum private|family|public and optional family_id

Enforce with RLS:
- Family resources readable only by members.
- Members can create invites; admins can promote/demote/remove.
- Prevent last-admin leaving without transferring admin (enforced atomically).
- Recipes:
  - public: readable by anyone (including logged out) by direct id lookup.
  - private: readable only by owner.
  - family: readable only by family members.

Note: 404/401 behavior is an app concern; in DB, "404 for unauthorized" is achieved by returning zero rows.
  </action>
  <verify>supabase start && supabase db reset</verify>
  <done>Migrations apply cleanly; RLS prevents data leaks</done>
</task>

<task type="auto">
  <name>Task 3: Implement invite + reset-request primitives</name>
  <files>supabase/functions/*</files>
  <action>
Implement minimal server-side primitives to support Phase 1 flows:
- Create invite (authenticated): generate single-use token, store hash, 7 day expiry, and send email invite link.
- Accept invite (authenticated): validate token (not expired/revoked/accepted), create membership, mark accepted.
- Reset-request semantics: return explicit "email not found" for unknown email; trigger provider reset email for known email.

Security:
- Store token hashed; raw token only appears in emailed invite link.
  </action>
  <verify>supabase functions list || true</verify>
  <done>Functions exist and can be invoked locally for integration</done>
</task>

</tasks>

<verification>
- [ ] supabase start succeeds
- [ ] supabase db reset succeeds
</verification>

<success_criteria>
- All tasks completed
- Schema exists and policies prevent data leaks
- Invite + reset primitives exist for frontend integration
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-identity-family-privacy/01-02-SUMMARY.md`
</output>
